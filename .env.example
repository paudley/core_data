# SPDX-FileCopyrightText: 2025 Blackcat InformaticsÂ® Inc.
# SPDX-License-Identifier: MIT

# ----------------------------------------------------------------------------
# Core Data Environment Template
# Copy this file to `.env` and customize values for your environment.
# ----------------------------------------------------------------------------

# PostgreSQL runtime
POSTGRES_SUPERUSER=postgres
# Store credentials in ./secrets/*. The manage CLI reads POSTGRES_SUPERUSER_PASSWORD_FILE
# and falls back to POSTGRES_SUPERUSER_PASSWORD only when provided explicitly.
POSTGRES_SUPERUSER_PASSWORD=
POSTGRES_SUPERUSER_PASSWORD_FILE=./secrets/postgres_superuser_password
POSTGRES_DB=postgres
POSTGRES_PORT=5432
PG_VERSION=17

# Application databases and owners to create automatically.
# Format: db_name:db_owner:owner_password
DATABASES_TO_CREATE=app_main:app_user:change_me,analytics:analytics_user:change_me

# Docker image build metadata
POSTGRES_IMAGE_NAME=core_data/postgres
POSTGRES_IMAGE_TAG=17.2-bookworm-core

AGE_VERSION=master

# Runtime resource limits
POSTGRES_MEMORY_LIMIT=4g
POSTGRES_CPU_LIMIT=2
POSTGRES_SHM_SIZE=1g

# Optional host overrides for PGDATA/WAL/pgBackRest if you prefer bind mounts over named volumes.
# PG_DATA_DIR=./data/postgres_data
# PG_WAL_DIR=./data/postgres_wal
# CORE_DATA_PGBACKREST_REPO_DIR=./data/pgbackrest_repo

# Container paths for persistent mounts (kept in sync with docker-compose.yml volume_prep command)
POSTGRES_DATA_MOUNT_PATH=/var/lib/postgresql/data
POSTGRES_WAL_MOUNT_PATH=/var/lib/postgresql/wal
POSTGRES_BACKREST_MOUNT_PATH=/var/lib/pgbackrest

# Core PostgreSQL tuning (map directly into postgresql.conf)
POSTGRES_MAX_CONNECTIONS=200
POSTGRES_LISTEN_ADDRESSES=0.0.0.0
PG_SHARED_BUFFERS=1GB
PG_EFFECTIVE_CACHE_SIZE=3GB
PG_WORK_MEM=16MB
PG_MAINTENANCE_WORK_MEM=256MB
PG_RANDOM_PAGE_COST=1.1
PG_EFFECTIVE_IO_CONCURRENCY=200
PG_MAX_WAL_SIZE=2GB
PG_MIN_WAL_SIZE=1GB
PG_WAL_KEEP_SIZE=2GB
PG_MAX_WAL_SENDERS=10
PG_CHECKPOINT_COMPLETION_TARGET=0.9
PG_LOG_MIN_DURATION_STATEMENT=500

# TLS configuration (self-signed certificates generated if files absent)
POSTGRES_SSL_ENABLED=on
POSTGRES_SSL_CERT_FILE=/var/lib/postgresql/data/tls/server.crt
POSTGRES_SSL_KEY_FILE=/var/lib/postgresql/data/tls/server.key
POSTGRES_SSL_SELF_SIGNED_SUBJECT=/CN=core_data_postgres
POSTGRES_SSL_SELF_SIGNED_DAYS=730

# PgHero authentication & exposure
PGHERO_USER=admin
PGHERO_PASSWORD=change_me
PGHERO_PORT=8080

# Networking
DOCKER_NETWORK_NAME=core_data_network
DOCKER_NETWORK_SUBNET=172.25.0.0/16
COMPOSE_PROFILES=valkey,pgbouncer,memcached

# Container execution context
# Defaults to the invoking user's UID/GID; override only if you need a specific account inside containers.
POSTGRES_UID=
POSTGRES_GID=
POSTGRES_RUNTIME_USER=postgres
POSTGRES_RUNTIME_GECOS=Core\ Data\ PostgreSQL\ Administrator
POSTGRES_RUNTIME_HOME=/home/postgres

# Logging driver tuning
POSTGRES_LOG_MAX_SIZE=100m
POSTGRES_LOG_MAX_FILE=5
POSTGRES_LOG_MODE=non-blocking
POSTGRES_LOG_BUFFER=4m

# Logical backup sidecar
LOGICAL_BACKUP_INTERVAL_SECONDS=86400
LOGICAL_BACKUP_RETENTION_DAYS=7
LOGICAL_BACKUP_OUTPUT=/backups/logical
LOGICAL_BACKUP_HOST_OUTPUT=./backups/logical
LOGICAL_BACKUP_EXCLUDE=postgres

# ValKey memory cache
VALKEY_PORT=6379
# Host port that Docker binds to; override if 6379 is unavailable locally.
VALKEY_HOST_PORT=6379
VALKEY_APPENDONLY=yes
VALKEY_MAXMEMORY=256mb
VALKEY_MAXMEMORY_POLICY=allkeys-lru
VALKEY_DATABASES=16
VALKEY_PASSWORD_FILE=./secrets/valkey_password

# PgBouncer connection pooling
PGBOUNCER_PORT=6432
# Host port that exposes PgBouncer; override to avoid collisions without
# changing the internal listener.
PGBOUNCER_HOST_PORT=6432
PGBOUNCER_POOL_MODE=session
PGBOUNCER_MAX_CLIENT_CONN=200
PGBOUNCER_DEFAULT_POOL_SIZE=20
PGBOUNCER_RESERVE_POOL_SIZE=5
PGBOUNCER_RESERVE_POOL_TIMEOUT=5
PGBOUNCER_MIN_POOL_SIZE=5
PGBOUNCER_AUTH_USER=pgbouncer_auth
PGBOUNCER_AUTH_PASSWORD_FILE=./secrets/pgbouncer_auth_password
PGBOUNCER_STATS_USER=pgbouncer_stats
PGBOUNCER_STATS_PASSWORD_FILE=./secrets/pgbouncer_stats_password
PGBOUNCER_ADMIN_USERS=postgres
PGBOUNCER_STATS_USERS=pgbouncer_stats

# Memcached hot object cache
MEMCACHED_PORT=11211
MEMCACHED_MEMORY_MB=128
MEMCACHED_MAX_CONNECTIONS=1024
MEMCACHED_THREADS=4

# Time zone for containers
TZ=UTC

# Daily maintenance tuning (optional)
# DAILY_PG_STAT_LIMIT=100
# DAILY_BUFFERCACHE_LIMIT=50
# DAILY_DEAD_TUPLE_THRESHOLD=100000
# DAILY_DEAD_TUPLE_RATIO=0.2
# DAILY_REPLICATION_LAG_THRESHOLD=300
# DAILY_INDEX_MIN_SIZE_MB=10
# DAILY_HTML_REPORT=true
